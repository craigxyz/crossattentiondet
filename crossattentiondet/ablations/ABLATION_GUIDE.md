# CSSA Fusion Ablation Study - Complete Guide

## Overview

This directory contains a complete ablation study system for testing CSSA (Channel Switching and Spatial Attention) fusion at different encoder stages with comprehensive logging and analysis.

## What You Have

### âœ… Implemented Components

1. **Flexible Multi-Stage CSSA Encoder** (`encoder_cssa_flexible.py`)
   - Supports any combination of stages: [1], [2,3], [1,2,3,4], etc.
   - Stages not using CSSA automatically use baseline FRM+FFM fusion
   - All backbone variants: mit_b0-b5

2. **Enhanced Training Script** (`scripts/train_cssa_ablation.py`)
   - Comprehensive logging to CSV and JSON
   - Per-epoch and per-batch metrics tracking
   - Configurable CSSA stages and hyperparameters
   - Progress tracking with timestamps

3. **Master Ablation Runner** (`scripts/run_cssa_ablations.py`)
   - Runs 11 experiments automatically
   - Phase 1: 7 stage configs at threshold=0.5
   - Phase 2: Top 2 configs at thresholds {0.3, 0.7}
   - Sequential execution with progress tracking
   - Aggregate results to summary CSV

4. **Results Analyzer** (`scripts/analyze_cssa_results.py`)
   - Parses all experiment results
   - Creates comparison tables (CSV + markdown)
   - Generates plots (mAP comparison, threshold sensitivity, size-specific)
   - Publication-ready summaries

## Quick Start

### Option 1: Run Full Ablation Study (Recommended)

Run all 11 experiments automatically:

```bash
python -u crossattentiondet/ablations/scripts/run_cssa_ablations.py \
    --data ../RGBX_Semantic_Segmentation/data/images \
    --labels ../RGBX_Semantic_Segmentation/data/labels \
    --output-base results/cssa_ablations \
    --epochs 25 \
    --backbone mit_b1
```

**Timeline:**
- ~6-7 hours per experiment
- 11 total experiments
- ~66-77 hours total (~3 days)

The script will:
1. Run 7 stage configurations (stages 1, 2, 3, 4, 2+3, 3+4, all)
2. Analyze which 2 configurations perform best
3. Run those 2 at thresholds 0.3 and 0.7
4. Save all results to `results/cssa_ablations/`

### Option 2: Run Single Experiment (Testing)

Test with a single configuration:

```bash
python -u crossattentiondet/ablations/scripts/train_cssa_ablation.py \
    --data ../RGBX_Semantic_Segmentation/data/images \
    --labels ../RGBX_Semantic_Segmentation/data/labels \
    --output-dir results/cssa_ablations/test_exp \
    --epochs 5 \
    --batch-size 2 \
    --backbone mit_b1 \
    --cssa-stages "3,4" \
    --cssa-thresh 0.5
```

### Option 3: Analyze Existing Results

After experiments complete:

```bash
python crossattentiondet/ablations/scripts/analyze_cssa_results.py \
    --results-dir results/cssa_ablations
```

This creates:
- Comparison tables (CSV)
- Plots (PNG)
- Summary report (markdown)

## Output Structure

```
results/cssa_ablations/
â”œâ”€â”€ master_log.txt                      # Overall progress log
â”œâ”€â”€ summary_all_experiments.csv         # Aggregated results
â”‚
â”œâ”€â”€ exp_001_s1_t0.5/                    # Stage 1, threshold=0.5
â”‚   â”œâ”€â”€ config.json                     # Experiment configuration
â”‚   â”œâ”€â”€ training.log                    # Detailed training log
â”‚   â”œâ”€â”€ metrics_per_epoch.csv           # Epoch-level metrics
â”‚   â”œâ”€â”€ metrics_per_batch.csv           # Batch-level metrics (every 10 batches)
â”‚   â”œâ”€â”€ final_results.json              # Final evaluation metrics
â”‚   â”œâ”€â”€ model_info.json                 # Model parameters/architecture
â”‚   â”œâ”€â”€ checkpoint.pth                  # Final checkpoint
â”‚   â””â”€â”€ checkpoint_best.pth             # Best checkpoint (lowest loss)
â”‚
â”œâ”€â”€ exp_002_s2_t0.5/                    # Stage 2, threshold=0.5
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ exp_007_s1234_t0.5/                 # All stages, threshold=0.5
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ exp_008_s34_t0.3/                   # Stages 3+4, threshold=0.3 (if top performer)
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ analysis/                           # Generated by analyze script
    â”œâ”€â”€ RESULTS_SUMMARY.md              # Markdown report
    â”œâ”€â”€ stage_comparison.csv            # Stage config comparison table
    â”œâ”€â”€ threshold_sensitivity.csv       # Threshold sensitivity table
    â”œâ”€â”€ mAP_by_stage_config.png         # Bar plot of mAP by stage
    â”œâ”€â”€ threshold_sensitivity.png       # Line plot of threshold effects
    â””â”€â”€ size_specific_performance.png   # Bar plot by object size
```

## Log Files Explained

### 1. `master_log.txt` (Overall Progress)

```
[2025-01-06 10:00:00] Starting CSSA ablation study - 11 experiments
[2025-01-06 10:00:01] Experiment 1/11: CSSA Stage 1, threshold=0.5
[2025-01-06 16:30:45]   Status: âœ“ SUCCESS (6.5 hrs)
[2025-01-06 16:30:45]   Results: mAP=0.XXX, AP50=0.XXX
...
```

### 2. `training.log` (Per Experiment)

```
============================================================
EXPERIMENT CONFIGURATION
============================================================
  experiment_id: exp_001_s1_t0.5
  cssa_stages: [1]
  threshold: 0.5
  ...

============================================================
EPOCH 1/25
============================================================
[10:05:23] Batch 10/3900 | Loss: 0.5234 | LR: 0.00500 | Time: 2.3s/batch
...
```

### 3. `metrics_per_epoch.csv`

```csv
epoch,train_loss,learning_rate,epoch_time_min,timestamp
1,0.3456,0.00500,85.2,2025-01-06 11:30:12
2,0.2987,0.00500,84.8,2025-01-06 12:55:34
...
```

### 4. `metrics_per_batch.csv` (Sampled every 10 batches)

```csv
epoch,batch,loss,learning_rate,time_per_batch_sec,timestamp
1,10,0.5234,0.00500,2.3,2025-01-06 10:05:23
1,20,0.4123,0.00500,2.2,2025-01-06 10:10:45
...
```

### 5. `final_results.json`

```json
{
  "experiment_id": "exp_001_s1_t0.5",
  "config": { ... },
  "results": {
    "mAP": 0.XXX,
    "mAP_50": 0.XXX,
    "mAP_75": 0.XXX,
    ...
  },
  "training": {
    "final_train_loss": 0.1234,
    "total_time_hours": 6.5
  },
  "model": {
    "total_params": 13456789,
    "trainable_params": 13456789
  }
}
```

## Experiments Matrix

### Phase 1: Stage Configurations (7 experiments Ã— threshold=0.5)

| Exp ID | Stages | Label | Description |
|--------|--------|-------|-------------|
| exp_001 | [1] | s1 | CSSA at Stage 1 only (early fusion) |
| exp_002 | [2] | s2 | CSSA at Stage 2 only (mid-early fusion) |
| exp_003 | [3] | s3 | CSSA at Stage 3 only (mid-late fusion) |
| exp_004 | [4] | s4 | CSSA at Stage 4 only (late fusion) |
| exp_005 | [2,3] | s23 | CSSA at Stages 2&3 (mid fusion) |
| exp_006 | [3,4] | s34 | CSSA at Stages 3&4 (late fusion) |
| exp_007 | [1,2,3,4] | s1234 | CSSA at all stages (progressive) |

### Phase 2: Threshold Sensitivity (4 experiments)

Based on top 2 performers from Phase 1, test thresholds {0.3, 0.7}:
- exp_008: Best config at threshold=0.3
- exp_009: Best config at threshold=0.7
- exp_010: 2nd best config at threshold=0.3
- exp_011: 2nd best config at threshold=0.7

## Git Ignore

All results are automatically excluded from git:
- `results/`
- `logs/`
- `checkpoints/*.pth`
- `**/*.png`, `**/*.jpg`, `**/*.pdf`
- `**/exp_*/`
- `**/metrics_*.csv`

Only code and documentation are tracked.

## Monitoring Progress

### During Training

**Watch master log:**
```bash
tail -f results/cssa_ablations/master_log.txt
```

**Watch specific experiment:**
```bash
tail -f results/cssa_ablations/exp_001_s1_t0.5/training.log
```

**Check CSV metrics:**
```bash
column -t -s, results/cssa_ablations/exp_001_s1_t0.5/metrics_per_epoch.csv | less
```

### Check Summary

```bash
# View summary CSV
column -t -s, results/cssa_ablations/summary_all_experiments.csv | less

# Count completed experiments
grep "Status: âœ“ SUCCESS" results/cssa_ablations/master_log.txt | wc -l
```

## Troubleshooting

### Experiment Fails

**Check the experiment's training.log:**
```bash
tail -100 results/cssa_ablations/exp_XXX_*/training.log
```

**Common issues:**
- CUDA OOM: Reduce `--batch-size` to 1
- Data not found: Check `--data` and `--labels` paths
- Import errors: Ensure you're in project root directory

### Resume After Interruption

The master runner doesn't support resume, but you can:

1. Check which experiments completed:
   ```bash
   ls results/cssa_ablations/exp_*/final_results.json
   ```

2. Run missing experiments individually:
   ```bash
   python -u crossattentiondet/ablations/scripts/train_cssa_ablation.py \
       --data ../RGBX_Semantic_Segmentation/data/images \
       --labels ../RGBX_Semantic_Segmentation/data/labels \
       --output-dir results/cssa_ablations/exp_005_s23_t0.5 \
       --epochs 25 \
       --cssa-stages "2,3" \
       --cssa-thresh 0.5
   ```

3. Manually add to summary CSV or re-run analysis

## Advanced Usage

### Custom Stage Configuration

```bash
python -u crossattentiondet/ablations/scripts/train_cssa_ablation.py \
    --data ... \
    --cssa-stages "1,3" \        # Custom: Stages 1 and 3 only
    --cssa-thresh 0.6 \          # Custom threshold
    --cssa-kernel 5 \            # Larger ECA kernel
    --output-dir results/custom_exp
```

### Different Backbone

```bash
python -u crossattentiondet/ablations/scripts/run_cssa_ablations.py \
    --data ... \
    --backbone mit_b2 \          # Larger backbone
    --epochs 30                  # More epochs
```

### Subset of Experiments

Modify `run_cssa_ablations.py` to test specific configurations:

```python
# In _define_initial_experiments():
stage_configs = [
    ([3, 4], "s34"),      # Only test stages 3+4
    ([1, 2, 3, 4], "s1234")  # And all stages
]
```

## Expected Results

Based on literature and your baseline:

**Best configurations (likely):**
- Late fusion (stages 3+4 or stage 4 only)
- Progressive fusion (all stages)

**Threshold sensitivity:**
- Lower threshold (0.3): More aggressive channel switching
- Higher threshold (0.7): More conservative, closer to baseline

**Training time:**
- Single experiment: 6-8 hours
- Full study: 66-77 hours (~3 days)

## Next Steps After Ablation

1. **Identify best configuration** from analysis
2. **Run extended training** (50 epochs) on best config
3. **Compare with baseline** FRM+FFM at same stages
4. **Implement other fusion methods** (GAFF, DetGate, ProbEn)
5. **Publish results** using generated tables and plots

## Files Reference

| File | Purpose |
|------|---------|
| `encoder_cssa_flexible.py` | Flexible multi-stage CSSA encoder |
| `scripts/train_cssa_ablation.py` | Single experiment trainer |
| `scripts/run_cssa_ablations.py` | Master experiment runner |
| `scripts/analyze_cssa_results.py` | Results analysis and visualization |
| `fusion/cssa.py` | CSSA fusion module |
| `fusion/base.py` | FusionBlock interface |

## Support

- Check logs first: `training.log` and `master_log.txt`
- Verify data paths are correct
- Ensure GPU has enough memory (reduce batch size if needed)
- All output is git-ignored, safe to experiment

Good luck with your ablation study! ðŸš€
